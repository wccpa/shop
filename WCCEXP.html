<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WCC Tracker</title>
    <style>
        /* BASE STYLES */
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 10px; text-align: center; color: #333; margin: 0; padding-top: 80px; }
        
        .container { 
            width: 100%; max-width: 600px; margin: auto; 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); box-sizing: border-box; 
        }

        /* FIXED HEADER */
        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-sizing: border-box; z-index: 500;
        }
        
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 50px; width: 50px; object-fit: contain; border-radius: 50%; }
        .header-title { font-weight: bold; font-size: 20px; color: #2c3e50; }

        .btn-refresh {
            background: #ecf0f1; border: none; color: #2c3e50;
            width: 45px; height: 45px; border-radius: 50%;
            font-size: 24px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-refresh:active { transform: rotate(180deg); background: #bdc3c7; }

        /* TOGGLES */
        .toggle-box { display: flex; margin-bottom: 20px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .toggle-btn { flex: 1; padding: 15px; border: none; cursor: pointer; font-weight: bold; background: #f1f2f6; transition: 0.3s; font-size: 14px; }
        .active-mode { background: #2c3e50; color: white; }

        /* INPUTS */
        input, select, textarea { width: 100%; padding: 16px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; -webkit-appearance: none; }
        input:focus, select:focus, textarea:focus { border-color: #3498db; outline: none; }
        textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        .req { border-left: 5px solid #e74c3c !important; }
        input[type="date"] { background-color: #f9f9f9; color: #2c3e50; font-weight: bold; }

        /* BUTTONS */
        button.submit { width: 100%; padding: 18px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-fill { background: #3498db; color: white; border: none; border-radius: 8px; width: 60px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-set-base { background: #7f8c8d; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 15px; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add-stop { background: #3498db; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 15px; font-weight: bold; }
        .btn-remove-stop { background: #e74c3c; color: white; border: none; padding: 0 15px; height: 54px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        
        .btn-report-gen { background: #8e44ad; color: white; width: 100%; padding: 18px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 18px; margin-top: 10px; }
        .btn-print-action { background: #7f8c8d; color: white; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* MILEAGE STOPS */
        .input-group { display: flex; gap: 5px; margin-bottom: 15px; }
        .input-group input { margin-bottom: 0; flex: 1; }
        .stop-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .stop-input { margin-bottom: 0 !important; flex: 1; }

        .hidden { display: none; }
        .note { font-size: 13px; color: #777; margin-bottom: 15px; display: block; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-card { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.4); max-height: 90vh; overflow-y: auto; position: relative; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #map-frame { width: 100%; height: 250px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; display: none; background: #eee; }
        .modal-btn-group { display: flex; gap: 15px; width: 100%; display: none; }
        .modal-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 16px; }

        /* REPORT STYLING */
        .report-section { display: none; margin-top: 20px; }
        .summary-box { background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .sum-item div:first-child { font-size: 12px; opacity: 0.8; }
        .sum-item div:last-child { font-size: 20px; font-weight: bold; }
        
        .report-card { background: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; text-align: left; }
        .rep-header-row { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; margin-bottom: 5px; }
        .rep-date { font-weight: bold; color: #2c3e50; }
        .rep-miles-val { font-weight: bold; color: #27ae60; white-space: nowrap; margin-left: 10px; font-size: 18px; }
        .rep-reason { font-size: 15px; color: #2980b9; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .rep-route { font-size: 12px; color: #555; line-height: 1.4; border-top: 1px solid #ececec; padding-top: 5px; }

        /* PRINT HEADER */
        .report-header-print { display: none; }

        @media print {
            body { background: white; padding: 0; margin: 0; }
            .app-header, .toggle-box, #report-controls, .btn-refresh, .btn-print-action { display: none !important; }
            .container { box-shadow: none; max-width: 100%; width: 100%; padding: 0; margin: 0; }
            .report-header-print { display: flex !important; align-items: center; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px; justify-content: space-between; text-align: left; }
            .ph-logo { height: 60px; width: 60px; object-fit: contain; }
            .ph-info { text-align: right; }
            .ph-title { font-size: 20px; font-weight: bold; color: #2c3e50; }
            .ph-meta { font-size: 11px; color: #555; font-family: monospace; }
            .summary-box { background: #eee; color: black; border: 1px solid #ccc; }
            .report-card { border: 1px solid #ccc; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div class="app-header">
    <div class="logo-area">
        <img src="https://wccpa.github.io/shop/WCC1.jpg" class="logo-img" alt="WCC Logo">
        <span class="header-title">WCC Tracker</span>
    </div>
    <button class="btn-refresh" onclick="location.reload()" title="Refresh App">‚Üª</button>
</div>

<div class="container">

    <div id="status-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="modal-spinner" class="spinner"></div>
            <div id="modal-icon" style="font-size: 60px; margin-bottom: 15px;"></div>
            <div id="modal-text" style="font-size: 22px; font-weight: bold; margin-bottom: 20px;">Processing...</div>
            <iframe id="map-frame" frameborder="0" style="border:0" allowfullscreen></iframe>
            <div id="edit-area" style="display:none; width:100%; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:20px;">
                <div style="font-size:13px; color:#555; font-weight:bold;">TOTAL MILES (ROUND TRIP)</div>
                <input type="number" id="confirm-miles-input" step="0.1" style="width:120px; text-align:center; font-size:24px; margin:10px 0;">
                <div style="font-size:12px; color:#777;">Full Loop Calculated</div>
            </div>
            <div id="modal-actions" class="modal-btn-group">
                <button class="modal-btn" style="background:#7f8c8d;" onclick="closeStatusModal()">CANCEL</button>
                <button class="modal-btn" style="background:#27ae60;" onclick="finalSaveMileage()">CONFIRM & SAVE</button>
            </div>
            <button id="btn-error-close" class="modal-btn" style="display:none; background:#c0392b; width:100%;" onclick="closeStatusModal()">GO BACK</button>
            <button id="btn-success-close" class="modal-btn" style="display:none; background:#27ae60; width:100%;" onclick="closeStatusModal()">CLOSE</button>
        </div>
    </div>

    <div class="toggle-box" style="margin-top:10px;">
        <button class="toggle-btn active-mode" onclick="switchMode('expense')" id="btn-exp">üí∞ Expense</button>
        <button class="toggle-btn" onclick="switchMode('mileage')" id="btn-mil">üöó Mileage</button>
        <button class="toggle-btn" onclick="switchMode('reports')" id="btn-rep">üìä Reports</button>
    </div>

    <div id="form-expense">
        <input type="date" id="ex-date" class="req">
        <input type="text" id="ex-item" class="req" placeholder="Item Name *">
        <input type="text" id="ex-cat" class="req" list="cat-list" placeholder="Category (Select or Type New) *">
        <datalist id="cat-list"></datalist>
        <input type="number" id="ex-cost" class="req" placeholder="Cost ($) *" step="0.01">
        <textarea id="ex-notes" placeholder="Notes (Optional)..."></textarea>
        <button class="submit" onclick="submitExpense()">SAVE EXPENSE</button>
    </div>

    <div id="form-mileage" class="hidden">
        <input type="date" id="mi-date" class="req">
        <button type="button" class="btn-set-base" onclick="openBaseModal()">üè¢ CONFIGURE BASE LOCATION</button>
        <div class="input-group">
            <input type="text" id="mi-start" class="req" placeholder="Start Location (Home Base) *">
            <button type="button" class="btn-fill" onclick="fillHomeBase()">‚¨áÔ∏è</button>
        </div>
        <div id="stops-container">
            <div class="stop-row"><input type="text" class="stop-input req" placeholder="Stop 1 *"></div>
        </div>
        <button type="button" class="btn-add-stop" onclick="addStopInput()">+ ADD ANOTHER STOP</button>
        <span class="note">üìç Start ‚ûî Stop 1 ‚ûî Stop 2... ‚ûî Start</span>
        <input type="text" id="mi-reason" class="req" placeholder="Reason (e.g. Site Visit) *">
        <textarea id="mi-notes" placeholder="Mileage Notes (Optional)..."></textarea>
        <button class="submit" style="background:#e67e22;" onclick="previewMileage()">VERIFY & PREVIEW ROUTE</button>
    </div>

    <div id="form-reports" class="hidden">
        <div id="report-controls">
            <label style="display:block; text-align:left; font-weight:bold; font-size:14px;">START DATE</label>
            <input type="date" id="rep-start">
            <label style="display:block; text-align:left; font-weight:bold; font-size:14px;">END DATE</label>
            <input type="date" id="rep-end">
            <button class="btn-report-gen" onclick="generateReport()">GENERATE MILEAGE REPORT</button>
        </div>

        <div id="report-output" class="report-section">
            <div class="report-header-print">
                <img src="https://wccpa.github.io/shop/WCC1.jpg" class="ph-logo">
                <div class="ph-info">
                    <div class="ph-title">Weekend Custom Creations LLC</div>
                    <div style="font-weight:bold; color:#777;">Mileage Report</div>
                    <div class="ph-meta" id="print-meta-time"></div>
                    <div class="ph-meta" id="print-meta-range"></div>
                </div>
            </div>

            <button class="btn-print-action" onclick="printReport()">üñ®Ô∏è PRINT / SAVE PDF</button>
            
            <div class="summary-box">
                <div class="sum-item"><div>Total Trips</div><div id="sum-trips">0</div></div>
                <div class="sum-item"><div>Total Miles</div><div id="sum-miles">0</div></div>
            </div>

            <div id="report-list"></div>
        </div>
    </div>
</div>

<div id="base-modal" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size:50px;">üè¢</div>
        <h3 style="margin-top:10px;">Set Default Location</h3>
        <p style="color:#666; font-size:14px;">Saved to this device for quick filling.</p>
        <input type="text" id="base-address-input" placeholder="e.g. 123 Main St, City, State">
        <div style="display:flex; gap:10px; width:100%;">
            <button class="modal-btn" style="background:#7f8c8d;" onclick="document.getElementById('base-modal').style.display='none'">CANCEL</button>
            <button class="modal-btn" style="background:#27ae60;" onclick="saveHomeBase()">SAVE</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx4vVR-eUd7x2AfauAcw4lIwYbGuWNc0KALgj0cwPZpPaNIZ9Seg7WjeSDeRLSXn9isKw/exec";
    let pendingMileageData = {};
    const defaultCats = ["Fuel", "Food", "Materials", "Office", "Other", "Tools"];

    window.onload = function() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const today = `${y}-${m}-${d}`;

        document.getElementById('ex-date').value = today;
        document.getElementById('mi-date').value = today;
        document.getElementById('rep-start').value = `${y}-${m}-01`;
        document.getElementById('rep-end').value = today;

        loadCategories();
    };

    function switchMode(mode) {
        document.getElementById('btn-exp').className = mode === 'expense' ? 'toggle-btn active-mode' : 'toggle-btn';
        document.getElementById('btn-mil').className = mode === 'mileage' ? 'toggle-btn active-mode' : 'toggle-btn';
        document.getElementById('btn-rep').className = mode === 'reports' ? 'toggle-btn active-mode' : 'toggle-btn';
        
        document.getElementById('form-expense').style.display = mode === 'expense' ? 'block' : 'none';
        document.getElementById('form-mileage').style.display = mode === 'mileage' ? 'block' : 'none';
        document.getElementById('form-reports').style.display = mode === 'reports' ? 'block' : 'none';
    }

    // --- MILEAGE ACTIONS ---
    function previewMileage() {
        const s = document.getElementById('mi-start').value;
        const r = document.getElementById('mi-reason').value;
        const dt = document.getElementById('mi-date').value;
        let stops = [];
        document.querySelectorAll('.stop-input').forEach(i => { if(i.value.trim()) stops.push(i.value.trim()); });

        if(!s || stops.length === 0 || !r) { showStatusModal("error", "Please fill required fields."); return; }
        
        showStatusModal("loading", "Calculating Route...");
        callScript({ type: "mileage_preview", startLoc: s, stops: JSON.stringify(stops) }, (resp) => {
            if(resp.status === "error") showStatusModal("error", resp.msg);
            else {
                pendingMileageData = { date: dt, startLoc: resp.cleanStart, endLoc: resp.cleanStops.join(" ‚ûî "), reason: r, notes: document.getElementById('mi-notes').value };
                showConfirmation(resp.cleanStart, resp.cleanStops, resp.miles);
            }
        });
    }

    function finalSaveMileage() {
        showStatusModal("loading", "Saving...");
        callScript({
            type: "mileage_save",
            date: pendingMileageData.date,
            startLoc: pendingMileageData.startLoc,
            endLoc: pendingMileageData.endLoc,
            miles: document.getElementById('confirm-miles-input').value,
            reason: pendingMileageData.reason,
            notes: pendingMileageData.notes
        }, (resp) => {
            showStatusModal("success", resp.msg);
            document.querySelectorAll('.stop-input').forEach((el, i) => { if(i === 0) el.value = ''; else el.parentElement.remove(); });
            document.getElementById('mi-reason').value = '';
            document.getElementById('mi-notes').value = '';
        });
    }

    // --- EXPENSE ACTIONS ---
    function submitExpense() {
        const dt = document.getElementById('ex-date').value;
        const it = document.getElementById('ex-item').value;
        const cat = document.getElementById('ex-cat').value;
        const cst = document.getElementById('ex-cost').value;
        if(!dt || !it || !cat || !cst) { showStatusModal("error", "Fill all fields."); return; }
        
        checkAndSaveNewCategory(cat);
        showStatusModal("loading", "Saving...");
        callScript({ type: "expense", date: dt, item: it, category: cat, cost: cst, notes: document.getElementById('ex-notes').value }, () => {
            showStatusModal("success", "Expense Saved!");
            document.getElementById('ex-item').value = '';
            document.getElementById('ex-cost').value = '';
            document.getElementById('ex-notes').value = '';
        });
    }

    // --- REPORT GENERATION ---
    function generateReport() {
        const s = document.getElementById('rep-start').value;
        const e = document.getElementById('rep-end').value;
        showStatusModal("loading", "Fetching Data...");
        callScript({ type: "get_mileage_report", startDate: s, endDate: e }, (resp) => {
            closeStatusModal();
            if(resp.status === "success") renderReport(resp.data, s, e);
            else alert(resp.msg);
        });
    }

    function renderReport(data, start, end) {
        document.getElementById('report-output').style.display = 'block';
        let totalVal = 0;
        const listDiv = document.getElementById('report-list');
        listDiv.innerHTML = data.length ? "" : "No logs found.";

        data.forEach(row => {
            // STRIP TEXT TO PREVENT NaN
            let mVal = parseFloat(String(row.miles).replace(/[^\d.-]/g, '')) || 0;
            totalVal += mVal;

            listDiv.innerHTML += `
            <div class="report-card">
                <div class="rep-header-row">
                    <span class="rep-date">${row.date}</span>
                    <span class="rep-miles-val">${mVal.toFixed(1)} mi</span>
                </div>
                <div class="rep-reason">${row.reason || 'Trip'}</div>
                <div class="rep-route">
                    <strong>FROM:</strong> ${row.start} <br>
                    <strong>ROUTE:</strong> ${row.route}
                    ${row.notes ? `<div style="margin-top:5px; border-top:1px solid #ddd; padding-top:5px; font-style:italic; font-size:11px;">Note: ${row.notes}</div>` : ''}
                </div>
            </div>`;
        });

        document.getElementById('sum-trips').innerText = data.length;
        document.getElementById('sum-miles').innerText = totalVal.toFixed(1);
        
        const now = new Date();
        document.getElementById('print-meta-time').innerText = `PULLED: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        document.getElementById('print-meta-range').innerText = `RANGE: ${start} to ${end}`;
    }

    function printReport() {
        const now = new Date();
        const p = (n) => n.toString().padStart(2, '0');
        const dStr = `${p(now.getMonth()+1)}-${p(now.getDate())}-${now.getFullYear()}`;
        let h = now.getHours();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        const tStr = `${p(h)}-${p(now.getMinutes())}-${p(now.getSeconds())}-${ampm}`;

        const oldTitle = document.title;
        document.title = `Weekend Custom Creations - Mileage Report - ${dStr} - ${tStr}`;
        window.print();
        setTimeout(() => { document.title = oldTitle; }, 1000);
    }

    // --- SHARED UTILS ---
    function loadCategories() {
        let cats = JSON.parse(localStorage.getItem('wcc_categories')) || defaultCats;
        cats.sort();
        const dl = document.getElementById('cat-list');
        dl.innerHTML = "";
        cats.forEach(c => { let o = document.createElement('option'); o.value = c; dl.appendChild(o); });
    }

    function checkAndSaveNewCategory(c) {
        let cats = JSON.parse(localStorage.getItem('wcc_categories')) || defaultCats;
        if(!cats.some(x => x.toLowerCase() === c.toLowerCase())) {
            cats.push(c.charAt(0).toUpperCase() + c.slice(1));
            localStorage.setItem('wcc_categories', JSON.stringify(cats));
            loadCategories();
        }
    }

    function addStopInput() {
        const c = document.getElementById('stops-container');
        const d = document.createElement('div');
        d.className = 'stop-row';
        d.innerHTML = `<input type="text" class="stop-input req" placeholder="Stop ${c.children.length+1} *"><button class="btn-remove-stop" onclick="this.parentElement.remove()">-</button>`;
        c.appendChild(d);
    }

    function fillHomeBase() { const s = localStorage.getItem('wcc_home_base'); if(s) document.getElementById('mi-start').value = s; else openBaseModal(); }
    function openBaseModal() { document.getElementById('base-modal').style.display = 'flex'; if(localStorage.getItem('wcc_home_base')) document.getElementById('base-address-input').value = localStorage.getItem('wcc_home_base'); }
    function saveHomeBase() { const a = document.getElementById('base-address-input').value; if(a) { localStorage.setItem('wcc_home_base', a); document.getElementById('base-modal').style.display='none'; if(!document.getElementById('mi-start').value) document.getElementById('mi-start').value=a; } }

    function callScript(data, callback) {
        const script = document.createElement('script');
        const cbName = 'cb' + Date.now();
        let params = `callback=${cbName}`;
        for(let key in data) { params += `&${key}=${encodeURIComponent(data[key])}`; }
        window[cbName] = function(resp) { callback(resp); delete window[cbName]; script.remove(); };
        script.src = `${API_URL}?${params}`;
        document.body.appendChild(script);
    }

    function showStatusModal(s, m) {
        const modal = document.getElementById('status-modal');
        modal.style.display = "flex";
        document.getElementById('modal-spinner').style.display = s === "loading" ? "block" : "none";
        document.getElementById('modal-icon').innerText = s === "error" ? "‚ö†Ô∏è" : (s === "success" ? "‚úÖ" : "");
        document.getElementById('modal-text').innerText = m;
        document.getElementById('modal-text').style.color = s === "error" ? "#c0392b" : (s === "success" ? "#27ae60" : "#2980b9");
        document.getElementById('map-frame').style.display = "none";
        document.getElementById('edit-area').style.display = "none";
        document.getElementById('modal-actions').style.display = "none";
        document.getElementById('btn-error-close').style.display = s === "error" ? "block" : "none";
        document.getElementById('btn-success-close').style.display = s === "success" ? "block" : "none";
    }

    function showConfirmation(s, st, m) {
        document.getElementById('modal-spinner').style.display = "none";
        document.getElementById('modal-text').innerText = "Confirm Loop Route";
        document.getElementById('modal-text').style.color = "#333";
        document.getElementById('confirm-miles-input').value = m;
        document.getElementById('edit-area').style.display = "block";
        document.getElementById('modal-actions').style.display = "flex";
        let d = ""; st.forEach(x => d += `+to:${encodeURIComponent(x)}`); d += `+to:${encodeURIComponent(s)}`;
        const frame = document.getElementById('map-frame');
        frame.src = `https://www.google.com/maps/embed/v1/directions?origin=${encodeURIComponent(s)}&destination=${encodeURIComponent(s)}&waypoints=${st.map(encodeURIComponent).join('|')}&key=YOUR_FREE_EMBED_KEY_OR_OLD_LINK_STYLE`;
        // USING RELIABLE NO-KEY FALLBACK
        frame.src = `https://maps.google.com/maps?q=${encodeURIComponent(s)}&daddr=${d.substring(4)}&output=embed`;
        frame.style.display = "block";
    }

    function closeStatusModal() { document.getElementById('status-modal').style.display = "none"; document.getElementById('map-frame').src = ""; }
</script>
</body>
</html>
